Bootstrap: docker
From: nvidia/cuda:11.1.1-cudnn8-devel-ubuntu20.04

%labels
    Author YourName
    Version 1.0
    Description RFdiffusion (not RFdiffusion2) container with PyTorch 1.9 and CUDA 11.1

%environment
    export LC_ALL=C
    export PATH=/usr/local/bin:$PATH
    export PYTHONPATH=/app/RFdiffusion:$PYTHONPATH

%post
    # 设置非交互环境以避免tzdata等包的交互式配置
    export DEBIAN_FRONTEND=noninteractive
    export TZ=Etc/UTC
    
    # 更新包管理器并安装基础工具
    apt-get update && apt-get install -y --no-install-recommends \
        wget \
        git \
        ca-certificates \
        build-essential \
        software-properties-common \
        gnupg2 \
        dialog \
        tzdata \
        libopenmpi-dev \
        libssl-dev \
        zlib1g-dev \
        libbz2-dev \
        liblzma-dev \
        libffi-dev \
        libncurses5-dev \
        libreadline-dev \
        libsqlite3-dev
    
    # 添加 deadsnakes PPA 并安装 Python 3.9
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys F23C5A6CF475977595C89F51BA6932366A755776
    add-apt-repository ppa:deadsnakes/ppa -y
    apt-get update && apt-get install -y --no-install-recommends \
        python3.9 \
        python3.9-dev \
        python3.9-distutils \
        python3.9-venv \
        python3-pip \
        python3.9-tk
    
    # 设置 Python 3.9 为默认版本
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.9 1
    update-alternatives --install /usr/bin/python python /usr/bin/python3.9 1
    
    # 安装 pip 和相关工具
    wget https://bootstrap.pypa.io/get-pip.py
    python3.9 get-pip.py
    rm get-pip.py
    
    # 升级 pip 和 setuptools
    pip3 install --upgrade pip setuptools wheel
    
    # 安装 PyTorch 1.9 及相关包 (CUDA 11.1 版本)
    pip3 install \
        torch==1.9.0+cu111 \
        torchvision==0.10.0+cu111 \
        torchaudio==0.9.0 \
        -f https://download.pytorch.org/whl/torch_stable.html
    
    # 安装其他 Python 包（RFdiffusion 可能需要）
    pip3 install \
        hydra-core==1.3.2 \
        pyrsistent \
        dgl-cu111 \
        mpi4py \
        biopython \
        pandas \
        numpy \
        scipy \
        matplotlib \
        seaborn \
        tqdm \
        requests \
        pyyaml \
        json5 \
        pathlib2
    
    # 创建 /app 目录
    mkdir -p /app
    cd /app
    
    # 克隆 RFdiffusion 仓库
    git clone https://github.com/RosettaCommons/RFdiffusion.git
    
    # 安装 RFdiffusion 依赖
    cd /app/RFdiffusion
    pip3 install -r requirements.txt
    
    # 下载模型文件
    mkdir -p models && cd models
    
    # 下载所有模型文件
    wget -q --show-progress http://files.ipd.uw.edu/pub/RFdiffusion/6f5902ac237024bdd0c176cb93063dc4/Base_ckpt.pt
    wget -q --show-progress http://files.ipd.uw.edu/pub/RFdiffusion/e29311f6f1bf1af907f9ef9f44b8328b/Complex_base_ckpt.pt
    wget -q --show-progress http://files.ipd.uw.edu/pub/RFdiffusion/60f09a193fb5e5ccdc4980417708dbab/Complex_Fold_base_ckpt.pt
    wget -q --show-progress http://files.ipd.uw.edu/pub/RFdiffusion/74f51cfb8b440f50d70878e05361d8f0/InpaintSeq_ckpt.pt
    wget -q --show-progress http://files.ipd.uw.edu/pub/RFdiffusion/76d00716416567174cdb7ca96e208296/InpaintSeq_Fold_ckpt.pt
    wget -q --show-progress http://files.ipd.uw.edu/pub/RFdiffusion/5532d2e1f3a4738decd58b19d633b3c3/ActiveSite_ckpt.pt
    wget -q --show-progress http://files.ipd.uw.edu/pub/RFdiffusion/12fc204edeae5b57713c5ad7dcb97d39/Base_epoch8_ckpt.pt
    
    # 设置模型文件权限
    chmod 644 /app/RFdiffusion/models/*.pt
    
    # 解压示例文件
    cd /app/RFdiffusion
    tar -xvf examples/ppi_scaffolds_subset.tar.gz -C examples/
    
    # 清理缓存以减小镜像大小
    apt-get clean
    rm -rf /var/lib/apt/lists/*
    pip3 cache purge
    rm -rf /root/.cache/pip



%help
    This is a Singularity container for RFdiffusion (not RFdiffusion2).
    
    The container includes:
    - Base image: nvidia/cuda:11.1.1-cudnn8-devel-ubuntu20.04
    - Python 3.9
    - PyTorch 1.9.0 with CUDA 11.1 support
    - torchvision 0.10.0 and torchaudio 0.9.0
    - Additional packages: hydra-core, pyrsistent, dgl-cu111
    - RFdiffusion cloned to /app/RFdiffusion
    - All required model files downloaded
    
    To use RFdiffusion:
    singularity exec container.sif python /app/RFdiffusion/scripts/run_inference.py [options]
    
    Note: This is RFdiffusion, not RFdiffusion2.
