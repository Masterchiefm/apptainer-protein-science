Bootstrap: docker-daemon
From: nvidia/cuda:12.2.2-cudnn8-devel-ubuntu22.04

%post
    # 更新包管理器并安装必要工具
    export DEBIAN_FRONTEND=noninteractive
    export TZ=Etc/UTC
    apt-get update && apt-get install -y --no-install-recommends \
        wget \
        curl \
        git \
        build-essential \
        ca-certificates \
        software-properties-common \
        && rm -rf /var/lib/apt/lists/*

    # 安装 Python 3.12
    add-apt-repository -y ppa:deadsnakes/ppa
    apt-get update && apt-get install -y --no-install-recommends \
        python3.12 \
        python3.12-dev \
        && rm -rf /var/lib/apt/lists/*

    # 设置 Python 3.12 为默认 python3
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1
    update-alternatives --set python3 /usr/bin/python3.12

    # 安装 pip
    curl -sS https://bootstrap.pypa.io/get-pip.py | python3.12
    pip3 config set global.index-url https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple

    # 安装 jupyterlab
    pip3 install jupyterlab pytest

    # 创建 /checkpoints 目录
    mkdir -p /checkpoints

    # 下载源码
    cd /
    git clone https://github.com/RosettaCommons/foundry.git

    # 设置环境变量
    echo 'export FOUNDRY_CHECKPOINT_DIRS=/checkpoints' >> $SINGULARITY_ENVIRONMENT

    # 安装 rc-foundry
    pip3 install "rc-foundry[all]"

    # 运行 foundry install
    foundry install rfd3 ligandmpnn rf3 --checkpoint-dir /checkpoints

%environment
    export FOUNDRY_CHECKPOINT_DIRS=/checkpoints
    export LC_ALL=C

%labels
    Author Mo Qiqin
    Version 1.0.0
    Description "Container with CUDA 12.2.2, Python 3.12, JupyterLab, and rc-foundry"

%help
    This container includes:
    - CUDA 12.2.2 with cuDNN 8
    - Python 3.12
    - JupyterLab
    - rc-foundry with all dependencies
    - Checkpoints directory at /checkpoints
