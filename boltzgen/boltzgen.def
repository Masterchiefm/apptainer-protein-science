Bootstrap: docker
From: nvidia/cuda:12.2.2-cudnn8-devel-ubuntu22.04

%post
    # 设置时区以避免交互输入
    export TZ=Etc/UTC
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime
    echo $TZ > /etc/timezone
    
    # 设置环境变量
    export DEBIAN_FRONTEND=noninteractive
    export PIP_NO_CACHE_DIR=1
    export PYTHONDONTWRITEBYTECODE=1
    export PYTHONUNBUFFERED=1
    export CUDA_HOME=/usr/local/cuda
    export PIP_EXTRA_INDEX_URL=https://download.pytorch.org/whl/cu121
    export HF_HOME=/cache
    
    # 更新系统并安装必要的软件包
    apt-get update && apt-get install -y \
        git \
        wget \
        curl \
        build-essential \
        software-properties-common \
        python3.11 \
        python3.11-dev \
        python3.11-distutils \
        python3-pip \
        python3.11-venv \
        && rm -rf /var/lib/apt/lists/*
    
    # 设置 Python 3.11 为默认 Python
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1
    update-alternatives --set python3 /usr/bin/python3.11
    
    # 安装 pip 并升级
    curl -sS https://bootstrap.pypa.io/get-pip.py | python3.11
    pip3 config set global.index-url https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple
    python3.11 -m pip install --upgrade pip
    
    # 创建 /app 目录
    mkdir -p /app
    
    # 克隆 boltzgen 仓库
    cd /
    git clone https://github.com/HannesStark/boltzgen.git /app
    
    # 安装 boltzgen
    cd /app
    python3.11 -m pip install -e .
    
    # 创建缓存目录
    mkdir -p "${HF_HOME}"
    
    # 下载所有模型（注意：这可能需要很长时间且需要大量磁盘空间）
    # boltzgen download all --cache "${HF_HOME}" --force_download

%environment
    # 设置环境变量
    export DEBIAN_FRONTEND=noninteractive
    export PIP_NO_CACHE_DIR=1
    export PYTHONDONTWRITEBYTECODE=1
    export PYTHONUNBUFFERED=1
    export CUDA_HOME=/usr/local/cuda
    export PATH=$CUDA_HOME/bin:$PATH
    export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH
    export PIP_EXTRA_INDEX_URL=https://download.pytorch.org/whl/cu121
    export HF_HOME=/cache
    
    # 设置时区
    export TZ=Etc/UTC



%labels
    Author Mo Qiqin
    Version 1.0
    Description "Singularity container with CUDA 12.2.2, Python 3.11, and boltzgen"

%help
    This container includes:
    - CUDA 12.2.2 with cuDNN 8
    - Ubuntu 22.04
    - Python 3.11
    - boltzgen repository cloned to /app
    
    To run boltzgen commands:
    singularity run container.sif [boltzgen arguments]
    
    To download all models (uncomment in %post section first):
    singularity exec container.sif python3.11 -m boltzgen download all --cache /cache --force_download
